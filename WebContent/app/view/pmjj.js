/*
 * File: app/view/pmjj.js
 *
 * This file was generated by Sencha Architect version 3.1.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.2.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.2.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('MyApp.view.pmjj', {
    extend: 'Ext.panel.Panel',
    alias: 'widget.pmjj',

    requires: [
        'Ext.form.Panel',
        'Ext.form.field.Display',
        'Ext.form.field.Number',
        'Ext.form.field.Date',
        'Ext.form.field.Time',
        'Ext.form.Label',
        'Ext.tab.Panel',
        'Ext.grid.Panel',
        'Ext.grid.column.Column',
        'Ext.grid.View',
        'Ext.tab.Tab',
        'Ext.toolbar.Toolbar',
        'Ext.Img'
    ],

    height: 614,
    width: 950,
    autoScroll: true,
    layout: 'absolute',
    title: '<font size=\'2.5px\'>拍卖竞价</font>',

    initComponent: function() {
        var me = this;

        Ext.applyIf(me, {
            items: [
                {
                    xtype: 'form',
                    x: 40,
                    y: 20,
                    height: 440,
                    id: 'jpxx',
                    itemId: 'jpxx',
                    width: 500,
                    layout: 'absolute',
                    bodyPadding: 10,
                    title: '竞拍信息',
                    jsonSubmit: true,
                    url: 'getjpxx',
                    items: [
                        {
                            xtype: 'displayfield',
                            x: 20,
                            y: 30,
                            id: 'jpzbpcbh',
                            width: 220,
                            fieldLabel: '批次编号',
                            name: 'zbpcbh'
                        },
                        {
                            xtype: 'displayfield',
                            x: 280,
                            y: 30,
                            width: 130,
                            fieldLabel: '单位额度',
                            name: 'dwed'
                        },
                        {
                            xtype: 'displayfield',
                            x: 20,
                            y: 80,
                            width: 150,
                            fieldLabel: '本批次总数量',
                            name: 'sl'
                        },
                        {
                            xtype: 'displayfield',
                            x: 280,
                            y: 80,
                            fieldLabel: '申购总数量',
                            name: 'sgzsl'
                        },
                        {
                            xtype: 'numberfield',
                            x: 20,
                            y: 250,
                            width: 200,
                            fieldLabel: '底价',
                            name: 'dj'
                        },
                        {
                            xtype: 'displayfield',
                            x: 280,
                            y: 140,
                            width: 200,
                            fieldLabel: '最高出价',
                            name: 'zgcj',
                            value: '无'
                        },
                        {
                            xtype: 'displayfield',
                            x: 20,
                            y: 135,
                            id: 'pczt1',
                            style: {
                                fontColor: 'red'
                            },
                            width: 220,
                            fieldLabel: '状态',
                            name: 'pczt',
                            value: '正在竞拍\r',
                            fieldStyle: ''
                        },
                        {
                            xtype: 'datefield',
                            x: 20,
                            y: 190,
                            width: 220,
                            fieldLabel: '竞价开始日期',
                            name: 'jjksrq',
                            value: '2010-01-01',
                            format: 'Y-m-d'
                        },
                        {
                            xtype: 'timefield',
                            x: 275,
                            y: 190,
                            width: 210,
                            fieldLabel: '开始时间',
                            msgTarget: 'under',
                            name: 'kssj',
                            allowBlank: false,
                            blankText: '不能为空',
                            format: 'H:i a',
                            submitFormat: 'H:i '
                        },
                        {
                            xtype: 'numberfield',
                            x: 280,
                            y: 255,
                            id: 'jg',
                            width: 190,
                            fieldLabel: '最低加价',
                            msgTarget: 'under',
                            name: 'zdjj',
                            value: 1000,
                            allowBlank: false,
                            blankText: '不能为空',
                            emptyText: '1000',
                            step: 1000
                        },
                        {
                            xtype: 'button',
                            handler: function(button, event) {
                                var form=Ext.getCmp('jpxx');
                                var record=form.getValues();
                                form.load({
                                    params:{zbpcbh:Ext.getCmp('jpzbpcbh')}
                                });
                            },
                            x: 125,
                            y: 365,
                            height: 25,
                            id: 'resetbtn',
                            width: 100,
                            text: '重置'
                        },
                        {
                            xtype: 'button',
                            handler: function(button, event) {
                                var form=Ext.getCmp('jpxx');

                                if(form.isValid())
                                {

                                    form.submit({
                                        url:'updatejpxx',

                                        success:function(form,action){

                                            Ext.MessageBox.alert('提示','设置成功');
                                            runner.stopAll();
                                            var dif=action.result.dif;
                                            var day=parseInt(dif/(24*3600*1000));
                                            var hour=parseInt(dif/(3600*1000))-day*24;
                                            var minute=parseInt(dif/(60*1000))-day*24*60-hour*60;
                                            var second=parseInt(dif/1000)-day*24*3600-hour*3600-minute*60;

                                            var djs=Ext.getCmp('pcqt');

                                            var task =runner.newTask({
                                                run: function()
                                                {
                                                    var flag=1;
                                                    if(second>0)
                                                    {
                                                        second=second-1;
                                                    }
                                                    else
                                                    {
                                                        if(minute>0)
                                                        {

                                                            second=59;
                                                            minute=minute-1;
                                                        }
                                                        else
                                                        {
                                                            if(hour>0)
                                                            {
                                                                minute=59;
                                                                hour=hour-1;
                                                            }
                                                            else
                                                            {
                                                                if(day>0)
                                                                {
                                                                    hour=23;
                                                                    day=day-1;
                                                                }
                                                                else
                                                                {
                                                                    djs.setValue('正在进行');
                                                                    Ext.getCmp('pczt').setValue('正在进行');
                                                                    flag=0;
                                                                }
                                                            }
                                                        }

                                                    }
                                                    if(flag==1)
                                                    {//alert(second);
                                                        djs.setValue(day+'天'+hour+'小时'+minute+'分'+second+'秒');
                                                    }

                                                },
                                                interval:1000
                                            }

                                            );
                                            task.start();

                                        },
                                        failure:function(){
                                            Ext.MessageBox.alert('提示','操作失败！');
                                        }
                                    });
                                }
                            },
                            x: 260,
                            y: 365,
                            height: 25,
                            id: 'surebtn',
                            width: 100,
                            text: '确定'
                        },
                        {
                            xtype: 'label',
                            x: 430,
                            y: 35,
                            text: '公顷/张'
                        },
                        {
                            xtype: 'label',
                            x: 170,
                            y: 85,
                            height: 10,
                            text: '张'
                        },
                        {
                            xtype: 'label',
                            x: 220,
                            y: 255,
                            height: 10,
                            text: '万元'
                        },
                        {
                            xtype: 'label',
                            x: 475,
                            y: 255,
                            height: 15,
                            width: 15,
                            text: '元'
                        },
                        {
                            xtype: 'label',
                            x: 410,
                            y: 85,
                            text: '张'
                        },
                        {
                            xtype: 'textfield',
                            x: 80,
                            y: 10,
                            hidden: true,
                            fieldLabel: 'Label',
                            name: 'id'
                        },
                        {
                            xtype: 'displayfield',
                            x: 15,
                            y: 305,
                            id: 'pcqt',
                            width: 210,
                            fieldLabel: '倒计时',
                            name: 'pcqt',
                            listeners: {
                                change: {
                                    fn: me.onPcqtChange,
                                    scope: me
                                }
                            }
                        }
                    ]
                },
                {
                    xtype: 'tabpanel',
                    x: 570,
                    y: 20,
                    width: 300,
                    activeTab: 0,
                    items: [
                        {
                            xtype: 'gridpanel',
                            height: 410,
                            width: 270,
                            autoScroll: true,
                            title: '出价记录',
                            store: 'cjjl',
                            columns: [
                                {
                                    xtype: 'gridcolumn',
                                    width: 108,
                                    dataIndex: 'userid',
                                    text: '用户'
                                },
                                {
                                    xtype: 'gridcolumn',
                                    width: 97,
                                    dataIndex: 'cjsj',
                                    text: '时间'
                                },
                                {
                                    xtype: 'gridcolumn',
                                    width: 84,
                                    dataIndex: 'cj',
                                    text: '出价'
                                }
                            ],
                            viewConfig: {
                                id: 'cc1'
                            },
                            tabConfig: {
                                xtype: 'tab',
                                width: 148
                            }
                        },
                        {
                            xtype: 'gridpanel',
                            height: 414,
                            autoScroll: true,
                            title: '实时结果',
                            store: 'ssjg',
                            columns: [
                                {
                                    xtype: 'gridcolumn',
                                    width: 98,
                                    dataIndex: 'userid',
                                    text: '用户名'
                                },
                                {
                                    xtype: 'gridcolumn',
                                    width: 96,
                                    dataIndex: 'sgsl',
                                    text: '申购数量'
                                },
                                {
                                    xtype: 'gridcolumn',
                                    renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
                                        if(value==true)
                                        {
                                            return '是';
                                        }
                                        else
                                        {
                                            return '否';
                                        }
                                    },
                                    width: 92,
                                    dataIndex: 'sfdb',
                                    text: '是否得标'
                                }
                            ],
                            tabConfig: {
                                xtype: 'tab',
                                width: 146
                            },
                            dockedItems: [
                                {
                                    xtype: 'toolbar',
                                    dock: 'top',
                                    items: [
                                        {
                                            xtype: 'button',
                                            handler: function(button, event) {
                                                Ext.Ajax.request(
                                                {
                                                    url:'updatejpresult',
                                                    method:'get',
                                                    headers:{

                                                        'Content-Type':'application/json'
                                                    },

                                                    success:function(response){



                                                        Ext.MessageBox.alert('提示','拍卖已经结束',function(){
                                                            var panel=Ext.getCmp('htglTabPanelMain');

                                                            var p=Ext.widget('jylcgl');
                                                            panel.removeAll();
                                                            panel.add(p);

                                                        });
                                                    },


                                                    failure:function(){
                                                        //Ext.MessageBox.alert('错误','操作失败！');
                                                    },

                                                    params:{'zbpcbh':Ext.getCmp('jpzbpcbh').getValue()}

                                                });
                                            },
                                            width: 304,
                                            text: '确认'
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ],
            dockedItems: [
                {
                    xtype: 'toolbar',
                    x: 139,
                    y: 13,
                    dock: 'top',
                    height: 40,
                    items: [
                        {
                            xtype: 'image',
                            height: 40,
                            width: 642,
                            src: 'images/step4.png'
                        },
                        {
                            xtype: 'label',
                            height: 12,
                            style: {
                                fontSize: '12px',
                                cursor: 'pointer',
                                color: 'blue'
                            },
                            width: 84,
                            text: '返回管理列表',
                            listeners: {
                                click: {
                                    fn: me.onLabelClick11,
                                    element: 'el',
                                    scope: me
                                }
                            }
                        }
                    ]
                }
            ]
        });

        me.callParent(arguments);
    },

    onPcqtChange: function(field, newValue, oldValue, eOpts) {
        //alert(newValue);
        if(newValue=='正在进行')
        {//alert();
            var cjstore=Ext.StoreMgr.get('cjjl');
            var jgstore=Ext.StoreMgr.get('ssjg');
            var n=cjstore.count();

            runner.stopAll();
            var pcqt=Ext.getCmp('pcqt');
            var num=30;
            var jxdjs =runner.newTask({
                run: function()
                {
                    //alert();
                    if(pcqt.getValue()!='0')
                    {
                        pcqt.setValue(num);
                        num=num-1;
                    }
                    else
                    {//alert();
                        runner.stopAll();
                        var btn1=Ext.getCmp('surebtn');
                        var btn2=Ext.getCmp('resetbtn');
                        //btn1.disable();
                       // btn2.disable();
                        pcqt.setValue('结束');
                    }
                },
                interval:1000
            }
            );
            jxdjs.start();

            var cjjl =runner.newTask({
                run: function()
                {
                    cjstore.load({
                        params:{zbpcbh:Ext.getCmp('jpzbpcbh').getValue()},
                        callback:function(){
                            if(n!=cjstore.count())
                            {
                                n=cjstore.count();
                                num=30;
                            }
                            var d = Ext.getDom('cc');

                            d.scrollTop = d.scrollHeight - d.offsetHeight;
                        }
                    }
                    );



                },
                interval:500
            }
            );
            cjjl.start();

            var ssjg =runner.newTask({
                run: function()
                {
                    jgstore.load({
                        params:{zbpcbh:Ext.getCmp('jpzbpcbh').getValue()}
                    }
                    );

                },
                interval:500
            }
            );
            ssjg.start();
        }

        if(newValue===0)
        {alert('结束');
            runner.stopAll();
            var btn1=Ext.getCmp('surebtn');
            var btn2=Ext.getCmp('resetbtn');
            btn1.disable();
            btn2.disable();
        }
    },

    onLabelClick11: function(label) {

        var panel=Ext.getCmp('htglTabPanelMain');

        var zbsg=Ext.widget('jylcgl');
        panel.removeAll();
        panel.add(zbsg);

    }

});